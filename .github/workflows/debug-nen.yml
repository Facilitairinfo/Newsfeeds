name: üêû Debug NEN Feed

on:
  workflow_dispatch:

jobs:
  debug-nen:
    runs-on: ubuntu-latest
    steps:
      # 1. Haal de repo op
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Installeer Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3. Installeer dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          playwright install --with-deps

      # 4. Snapshot ophalen
      - name: Haal NEN HTML op
        run: |
          mkdir -p debug
          echo "üì∏ Snapshot van NEN-site ophalen..."
          curl -sL https://www.nen.nl/nieuws -o debug/nen_raw.html || echo "Snapshot mislukt"
          cp debug/nen_raw.html docs/nen_raw.html

      # 5. Scraper starten
      - name: Scraper starten
        run: |
          echo "üöÄ Start scraper met config"
          python scripts/run_scraper.py --config configs/sites-nen-nieuws.yml || echo "Scraper faalde"

      # 6. Fallback voor lege XML
      - name: Forceer lege XML als fallback
        run: |
          if [ ! -f docs/sites-nen-nieuws.xml ]; then
            echo "‚ö†Ô∏è Geen XML aangetroffen, schrijf lege placeholder"
            echo '<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"><channel><title>NEN Nieuws</title><description>Geen items gevonden</description><link>https://www.nen.nl/nieuws</link></channel></rss>' > docs/sites-nen-nieuws.xml
          fi

      # 7. Commit en push snapshot + XML
      - name: Commit snapshot en XML
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add docs/nen_raw.html docs/sites-nen-nieuws.xml
          git commit -m "Update NEN snapshot en XML [skip ci]" || echo "Geen wijzigingen"
          git push origin main
